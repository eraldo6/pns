{% extends "base.html" %}

{% block title %}Dashboard - Privacy Network System{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1 class="mb-4">
            <i class="fas fa-tachometer-alt me-2"></i>
            System Dashboard
        </h1>
    </div>
</div>

<!-- System Status Cards -->
<div class="row mb-4">
    <div class="col-md-3 mb-3">
        <div class="card h-100">
            <div class="card-body text-center">
                <i class="fas fa-wallet fa-3x text-primary mb-3"></i>
                <h5 class="card-title">Wallets</h5>
                <h2 class="text-primary" data-status="wallets_count">{{ status.get('wallets_count', 0) }}</h2>
                <p class="text-muted">Active wallets</p>
            </div>
        </div>
    </div>
    
    <div class="col-md-3 mb-3">
        <div class="card h-100">
            <div class="card-body text-center">
                <i class="fas fa-coins fa-3x text-success mb-3"></i>
                <h5 class="card-title">Tokens</h5>
                <h2 class="text-success" data-status="tokens_count">{{ status.get('tokens_count', 0) }}</h2>
                <p class="text-muted">€<span data-status="total_token_value">{{ status.get('total_token_value', 0) }}</span> total value</p>
            </div>
        </div>
    </div>
    
    <div class="col-md-3 mb-3">
        <div class="card h-100">
            <div class="card-body text-center">
                <i class="fas fa-ticket-alt fa-3x text-warning mb-3"></i>
                <h5 class="card-title">Vouchers</h5>
                <h2 class="text-warning" data-status="vouchers_count">{{ status.get('vouchers_count', 0) }}</h2>
                <p class="text-muted"><span data-status="available_vouchers">{{ status.get('available_vouchers', 0) }}</span> available</p>
            </div>
        </div>
    </div>
    
    <div class="col-md-3 mb-3">
        <div class="card h-100">
            <div class="card-body text-center">
                <i class="fas fa-exchange-alt fa-3x text-info mb-3"></i>
                <h5 class="card-title">Transactions</h5>
                <h2 class="text-info" data-status="transactions_count">{{ status.get('transactions_count', 0) }}</h2>
                <p class="text-muted"><span data-status="anonymous_transactions">{{ status.get('anonymous_transactions', 0) }}</span> anonymous</p>
            </div>
        </div>
    </div>
</div>

<!-- Quick Actions -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-bolt me-2"></i>
                    Quick Actions
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3 mb-3">
                        <button class="btn btn-primary w-100" onclick="createWallet()">
                            <i class="fas fa-plus me-2"></i>
                            Create Wallet
                        </button>
                    </div>
                    <div class="col-md-3 mb-3">
                        <button class="btn btn-success w-100" onclick="issueToken()">
                            <i class="fas fa-coins me-2"></i>
                            Issue Token
                        </button>
                    </div>
                    <div class="col-md-3 mb-3">
                        <button class="btn btn-warning w-100" onclick="issueVoucher()">
                            <i class="fas fa-ticket-alt me-2"></i>
                            Issue Voucher
                        </button>
                    </div>
                    <div class="col-md-3 mb-3">
                        <button class="btn btn-info w-100" onclick="runDemo()">
                            <i class="fas fa-play me-2"></i>
                            Run Demo
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- System Overview -->
<div class="row">
    <div class="col-md-6 mb-4">
        <div class="card h-100">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-shield-alt me-2"></i>
                    Compliance Status
                </h5>
            </div>
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <span>AML Flagged Transactions:</span>
                    <span class="badge bg-warning" data-status="aml_flagged_count">{{ status.get('aml_flagged_count', 0) }}</span>
                </div>
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <span>Offline Transactions:</span>
                    <span class="badge bg-info" data-status="offline_transactions_count">{{ status.get('offline_transactions_count', 0) }}</span>
                </div>
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <span>Pending Offline:</span>
                    <span class="badge bg-secondary" data-status="pending_offline_count">{{ status.get('pending_offline_count', 0) }}</span>
                </div>
                <div class="d-flex justify-content-between align-items-center">
                    <span>ZKP Proofs:</span>
                    <span class="badge bg-primary" data-status="zkp_proofs_count">{{ status.get('zkp_proofs_count', 0) }}</span>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-6 mb-4">
        <div class="card h-100">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-chart-pie me-2"></i>
                    Privacy Statistics
                </h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label class="form-label">Anonymous Transactions</label>
                    <div class="progress">
                        {% set anonymous_transactions = status.get('anonymous_transactions', 0) %}
                        {% set transactions_count = status.get('transactions_count', 1) %}
                        {% set anonymous_percentage = (anonymous_transactions / transactions_count * 100) if transactions_count > 0 else 0 %}
                        <div class="progress-bar bg-success" style="width: {{ anonymous_percentage }}%">
                            {{ "%.1f"|format(anonymous_percentage) }}%
                        </div>
                    </div>
                </div>
                <div class="mb-3">
                    <label class="form-label">Token Distribution</label>
                    <div class="progress">
                        {% set total_token_value = status.get('total_token_value', 0) %}
                        {% set token_percentage = (total_token_value / 1000 * 100) if total_token_value > 0 else 0 %}
                        <div class="progress-bar bg-primary" style="width: {{ token_percentage if token_percentage <= 100 else 100 }}%">
                            €{{ total_token_value }}
                        </div>
                    </div>
                </div>
                <div class="mb-3">
                    <label class="form-label">Voucher Usage</label>
                    <div class="progress">
                        {% set vouchers_count = status.get('vouchers_count', 1) %}
                        {% set available_vouchers = status.get('available_vouchers', 0) %}
                        {% set voucher_percentage = ((vouchers_count - available_vouchers) / vouchers_count * 100) if vouchers_count > 0 else 0 %}
                        <div class="progress-bar bg-warning" style="width: {{ voucher_percentage }}%">
                            {{ "%.1f"|format(voucher_percentage) }}%
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Recent Activity -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-history me-2"></i>
                    Recent Activity
                </h5>
                <button class="btn btn-sm btn-outline-primary" onclick="refreshActivity()">
                    <i class="fas fa-sync-alt me-1"></i>
                    Refresh
                </button>
            </div>
            <div class="card-body">
                <div id="activity-feed">
                    <div class="text-center text-muted">
                        <i class="fas fa-spinner fa-spin fa-2x mb-2"></i>
                        <p>Loading recent activity...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modals -->
<!-- Create Wallet Modal -->
<div class="modal fade" id="createWalletModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-wallet me-2"></i>
                    Create New Wallet
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>This will create a new wallet with a unique ID and cryptographic keypair.</p>
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    The wallet will be created with zero balance. You can issue tokens to it later.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="confirmCreateWallet()">
                    <i class="fas fa-plus me-2"></i>
                    Create Wallet
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Issue Token Modal -->
<div class="modal fade" id="issueTokenModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-coins me-2"></i>
                    Issue New Token
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="issueTokenForm">
                    <div class="mb-3">
                        <label for="tokenValue" class="form-label">Token Value (€)</label>
                        <input type="number" class="form-control" id="tokenValue" value="100" min="1" step="0.01" required>
                    </div>
                    <div class="mb-3">
                        <label for="tokenOwner" class="form-label">Owner Wallet ID</label>
                        <select class="form-select" id="tokenOwner" required>
                            <option value="">Select a wallet...</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" onclick="confirmIssueToken()">
                    <i class="fas fa-coins me-2"></i>
                    Issue Token
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Issue Voucher Modal -->
<div class="modal fade" id="issueVoucherModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-ticket-alt me-2"></i>
                    Issue Anonymity Voucher
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="issueVoucherForm">
                    <div class="mb-3">
                        <label for="voucherLimit" class="form-label">Value Limit (€)</label>
                        <input type="number" class="form-control" id="voucherLimit" value="50" min="1" step="0.01" required>
                    </div>
                    <div class="mb-3">
                        <label for="voucherOwner" class="form-label">Issued To Wallet ID</label>
                        <select class="form-select" id="voucherOwner" required>
                            <option value="">Select a wallet...</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-warning" onclick="confirmIssueVoucher()">
                    <i class="fas fa-ticket-alt me-2"></i>
                    Issue Voucher
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Load wallets for dropdowns
    function loadWallets() {
        fetch('/api/status')
            .then(response => response.json())
            .then(data => {
                const tokenOwner = document.getElementById('tokenOwner');
                const voucherOwner = document.getElementById('voucherOwner');
                
                if (data.wallets && data.wallets.length > 0) {
                    tokenOwner.innerHTML = '<option value="">Select a wallet...</option>';
                    voucherOwner.innerHTML = '<option value="">Select a wallet...</option>';
                    
                    data.wallets.forEach(wallet => {
                        const option1 = document.createElement('option');
                        option1.value = wallet.wallet_id;
                        option1.textContent = `${wallet.wallet_id} (€${wallet.token_balance})`;
                        tokenOwner.appendChild(option1);
                        
                        const option2 = document.createElement('option');
                        option2.value = wallet.wallet_id;
                        option2.textContent = `${wallet.wallet_id} (€${wallet.token_balance})`;
                        voucherOwner.appendChild(option2);
                    });
                }
            });
    }
    
    // Create wallet function
    function createWallet() {
        const modal = new bootstrap.Modal(document.getElementById('createWalletModal'));
        modal.show();
    }
    
    function confirmCreateWallet() {
        const button = event.target;
        const originalText = button.innerHTML;
        button.innerHTML = '<span class="loading"></span> Creating...';
        button.disabled = true;
        
        fetch('/api/wallets', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast('Success', 'Wallet created successfully!', 'success');
                // Refresh page to update status
                setTimeout(() => location.reload(), 1000);
            } else {
                showToast('Error', data.error, 'error');
            }
        })
        .catch(error => {
            showToast('Error', 'Failed to create wallet', 'error');
        })
        .finally(() => {
            button.innerHTML = originalText;
            button.disabled = false;
            bootstrap.Modal.getInstance(document.getElementById('createWalletModal')).hide();
        });
    }
    
    // Issue token function
    function issueToken() {
        loadWallets();
        const modal = new bootstrap.Modal(document.getElementById('issueTokenModal'));
        modal.show();
    }
    
    function confirmIssueToken() {
        const value = document.getElementById('tokenValue').value;
        const ownerWalletId = document.getElementById('tokenOwner').value;
        
        if (!value || !ownerWalletId) {
            showToast('Error', 'Please fill in all fields', 'error');
            return;
        }
        
        const button = event.target;
        const originalText = button.innerHTML;
        button.innerHTML = '<span class="loading"></span> Issuing...';
        button.disabled = true;
        
        fetch('/api/tokens', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                value: parseFloat(value),
                owner_wallet_id: ownerWalletId
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast('Success', 'Token issued successfully!', 'success');
                setTimeout(() => location.reload(), 1000);
            } else {
                showToast('Error', data.error, 'error');
            }
        })
        .catch(error => {
            showToast('Error', 'Failed to issue token', 'error');
        })
        .finally(() => {
            button.innerHTML = originalText;
            button.disabled = false;
            bootstrap.Modal.getInstance(document.getElementById('issueTokenModal')).hide();
        });
    }
    
    // Issue voucher function
    function issueVoucher() {
        loadWallets();
        const modal = new bootstrap.Modal(document.getElementById('issueVoucherModal'));
        modal.show();
    }
    
    function confirmIssueVoucher() {
        const valueLimit = document.getElementById('voucherLimit').value;
        const issuedToWalletId = document.getElementById('voucherOwner').value;
        
        if (!valueLimit || !issuedToWalletId) {
            showToast('Error', 'Please fill in all fields', 'error');
            return;
        }
        
        const button = event.target;
        const originalText = button.innerHTML;
        button.innerHTML = '<span class="loading"></span> Issuing...';
        button.disabled = true;
        
        fetch('/api/vouchers', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                value_limit: parseFloat(valueLimit),
                issued_to_wallet_id: issuedToWalletId
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast('Success', 'Voucher issued successfully!', 'success');
                setTimeout(() => location.reload(), 1000);
            } else {
                showToast('Error', data.error, 'error');
            }
        })
        .catch(error => {
            showToast('Error', 'Failed to issue voucher', 'error');
        })
        .finally(() => {
            button.innerHTML = originalText;
            button.disabled = false;
            bootstrap.Modal.getInstance(document.getElementById('issueVoucherModal')).hide();
        });
    }
    
    // Run demo function
    function runDemo() {
        const button = event.target;
        const originalText = button.innerHTML;
        button.innerHTML = '<span class="loading"></span> Running...';
        button.disabled = true;
        
        fetch('/api/demo', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast('Info', 'Demo started. Check the demo page for progress.', 'info');
            } else {
                showToast('Error', data.error, 'error');
            }
        })
        .catch(error => {
            showToast('Error', 'Failed to start demo', 'error');
        })
        .finally(() => {
            button.innerHTML = originalText;
            button.disabled = false;
        });
    }
    
    // Refresh activity feed
    function refreshActivity() {
        const feed = document.getElementById('activity-feed');
        feed.innerHTML = '<div class="text-center text-muted"><i class="fas fa-spinner fa-spin fa-2x mb-2"></i><p>Loading recent activity...</p></div>';
        
        // Simulate loading activity (in a real app, this would fetch from an API)
        setTimeout(() => {
            feed.innerHTML = `
                <div class="list-group list-group-flush">
                    <div class="list-group-item d-flex justify-content-between align-items-center">
                        <div>
                            <i class="fas fa-wallet text-primary me-2"></i>
                            <strong>Wallet Created</strong>
                            <small class="text-muted d-block">New wallet wallet_abc123 created</small>
                        </div>
                        <small class="text-muted">2 minutes ago</small>
                    </div>
                    <div class="list-group-item d-flex justify-content-between align-items-center">
                        <div>
                            <i class="fas fa-coins text-success me-2"></i>
                            <strong>Token Issued</strong>
                            <small class="text-muted d-block">Token token_001 (€100) issued to wallet_abc123</small>
                        </div>
                        <small class="text-muted">5 minutes ago</small>
                    </div>
                    <div class="list-group-item d-flex justify-content-between align-items-center">
                        <div>
                            <i class="fas fa-exchange-alt text-info me-2"></i>
                            <strong>Transaction Executed</strong>
                            <small class="text-muted d-block">Transfer of €50 from wallet_abc123 to wallet_def456</small>
                        </div>
                        <small class="text-muted">10 minutes ago</small>
                    </div>
                </div>
            `;
        }, 1000);
    }
    
    // Load initial data
    document.addEventListener('DOMContentLoaded', function() {
        refreshActivity();
    });
</script>
{% endblock %} 